<!-- resources/mappers/AdminUserMapper.xml -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aloha.zootopia.mapper.AdminUserMapper">

  <!-- ìš”ì•½ ì¡°íšŒ -->
  <resultMap id="UserSummaryMap" type="com.aloha.zootopia.domain.AdminUserSummary">
    <id property="userId" column="user_id" />
    <result property="email" column="email"/>
    <result property="nickname" column="nickname"/>
    <result property="status" column="status"/>
    <result property="createdAt" column="created_at"/>
     <result property="reportCount" column="report_count"/>
  </resultMap>

  <select id="findUsers" resultMap="UserSummaryMap">
    SELECT
      u.user_id,
      u.email,
      u.nickname,
      u.status,
      u.created_at,
      <!-- /* ðŸ‘‡ ì‹ ê³  ê±´ìˆ˜ ì»¬ëŸ¼ ì¶”ê°€ (ì „ì²´ ê±´ìˆ˜) */ -->
      (SELECT COUNT(1)
        FROM user_report ur
        WHERE ur.reported_user_id = u.user_id
        <!-- /* ì§„í–‰ì¤‘ë§Œ ë³´ê³  ì‹¶ìœ¼ë©´ â†“ ì£¼ì„ í•´ì œ
          AND ur.status = 'PENDING'
        */ -->
      ) AS report_count
    FROM users u
    <where>
      <if test="q != null and q != ''">
        AND (u.email LIKE CONCAT('%',#{q},'%') OR u.nickname LIKE CONCAT('%',#{q},'%'))
      </if>
      <if test="status != null and status != ''">
        AND u.status = #{status}
      </if>
      <if test="role != null and role != ''">
        AND EXISTS (
          SELECT 1
            FROM user_auth ua
          WHERE ua.email = u.email
            AND ua.auth  = #{role}
        )
      </if>
      <if test="from != null">AND u.created_at &gt;= #{from}</if>
      <if test="to != null">AND u.created_at &lt;= #{to}</if>
      AND u.is_deleted = 0
    </where>
    ORDER BY ${sortColumn} ${sortDir}
    LIMIT #{size} OFFSET #{offset}
  </select>


  <select id="countUsers" resultType="long">
    SELECT COUNT(*)
      FROM users u
    <where>
      <if test="q != null and q != ''">
        AND (u.email LIKE CONCAT('%',#{q},'%') OR u.nickname LIKE CONCAT('%',#{q},'%'))
      </if>
      <if test="status != null and status != ''">
        AND u.status = #{status}
      </if>
      <!-- âœ… role í•„í„°: email ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½ -->
      <if test="role != null and role != ''">
        AND EXISTS (
          SELECT 1
            FROM user_auth ua
           WHERE ua.email = u.email
             AND ua.auth  = #{role}
        )
      </if>
      <if test="from != null">AND u.created_at &gt;= #{from}</if>
      <if test="to != null">AND u.created_at &lt;= #{to}</if>
      AND u.is_deleted = 0
    </where>
  </select>

  <!-- ìƒì„¸ ì¡°íšŒ -->
  <resultMap id="UserDetailMap" type="com.aloha.zootopia.domain.AdminUserDetail">
    <id property="userId" column="user_id"/>
    <result property="email" column="email"/>
    <result property="nickname" column="nickname"/>
    <result property="status" column="status"/>
    <result property="memo" column="memo"/>
    <result property="createdAt" column="created_at"/>
    <result property="updatedAt" column="updated_at"/>
    <result property="postCount" column="post_count"/>
    <result property="commentCount" column="comment_count"/>
  </resultMap>

  <select id="findUserById" resultMap="UserDetailMap">
    SELECT u.user_id,
           u.email,
           u.nickname,
           u.status,
           u.memo,
           u.created_at,
           u.updated_at,
           (SELECT COUNT(1)
              FROM posts p
             WHERE p.user_id = u.user_id) AS post_count,
           (SELECT COUNT(1)
              FROM post_comments c
             WHERE c.user_id = u.user_id
               AND c.is_deleted = 0) AS comment_count
      FROM users u
     WHERE u.user_id = #{userId}
       AND u.is_deleted = 0
  </select>

  <!-- ======================= -->
  <!--        Roles (email)    -->
  <!-- ======================= -->

  <!-- âœ… userIdë¡œ ë°›ì€ ë’¤ ë‚´ë¶€ì—ì„œ email join -->
  <select id="findRolesByUserId" parameterType="int" resultType="string">
    SELECT ua.auth
      FROM user_auth ua
      JOIN users u ON u.email = ua.email
     WHERE u.user_id = #{userId}
  </select>

  <!-- âœ… ì‚­ì œë„ email ê¸°ì¤€ìœ¼ë¡œ -->
  <delete id="deleteRoles" parameterType="int">
    DELETE FROM user_auth
     WHERE email = (SELECT email FROM users WHERE user_id = #{userId})
  </delete>

  <!-- âœ… ë‹¨ê±´ ì¶”ê°€ (userId -> email ì„œë¸Œì¿¼ë¦¬) -->
  <insert id="insertRole">
    INSERT INTO user_auth (email, auth)
    VALUES ((SELECT email FROM users WHERE user_id = #{userId}), #{role})
  </insert>

  <!-- âœ… ë°°ì¹˜ ì¶”ê°€ (userId -> email ì„œë¸Œì¿¼ë¦¬) -->
  <insert id="insertRolesBatch">
    INSERT INTO user_auth (email, auth)
    VALUES
    <foreach collection="roles" item="r" separator=",">
      ((SELECT email FROM users WHERE user_id = #{userId}), #{r})
    </foreach>
  </insert>

  <!-- ì‚¬ìš©ìž í•„ë“œ ì—…ë°ì´íŠ¸ -->
  <update id="updateUserFields">
    UPDATE users
       <set>
         <if test="fields.nickname != null"> nickname = #{fields.nickname}, </if>
         <if test="fields.status   != null"> status   = #{fields.status},   </if>
         <if test="fields.memo     != null"> memo     = #{fields.memo},     </if>
         updated_at = NOW()
       </set>
     WHERE user_id = #{userId}
  </update>

</mapper>
