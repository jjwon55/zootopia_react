<!-- resources/mappers/AdminUserMapper.xml -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aloha.zootopia.mapper.AdminUserMapper">

  <!-- 요약 조회 -->
  <resultMap id="UserSummaryMap" type="com.aloha.zootopia.domain.AdminUserSummary">
    <id property="userId" column="user_id" />
    <result property="email" column="email"/>
    <result property="nickname" column="nickname"/>
    <result property="status" column="status"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <select id="findUsers" resultMap="UserSummaryMap">
    SELECT u.user_id, u.email, u.nickname, u.status, u.created_at
      FROM users u
    <where>
      <if test="q != null and q != ''">
        AND (u.email LIKE CONCAT('%',#{q},'%') OR u.nickname LIKE CONCAT('%',#{q},'%'))
      </if>
      <if test="status != null and status != ''">
        AND u.status = #{status}
      </if>
      <!-- ✅ role 필터: email 기반으로 변경 -->
      <if test="role != null and role != ''">
        AND EXISTS (
          SELECT 1
            FROM user_auth ua
           WHERE ua.email = u.email
             AND ua.auth  = #{role}
        )
      </if>
      <if test="from != null">AND u.created_at &gt;= #{from}</if>
      <if test="to != null">AND u.created_at &lt;= #{to}</if>
      AND u.is_deleted = 0
    </where>
    ORDER BY ${sortColumn} ${sortDir}
    LIMIT #{size} OFFSET #{offset}
  </select>

  <select id="countUsers" resultType="long">
    SELECT COUNT(*)
      FROM users u
    <where>
      <if test="q != null and q != ''">
        AND (u.email LIKE CONCAT('%',#{q},'%') OR u.nickname LIKE CONCAT('%',#{q},'%'))
      </if>
      <if test="status != null and status != ''">
        AND u.status = #{status}
      </if>
      <!-- ✅ role 필터: email 기반으로 변경 -->
      <if test="role != null and role != ''">
        AND EXISTS (
          SELECT 1
            FROM user_auth ua
           WHERE ua.email = u.email
             AND ua.auth  = #{role}
        )
      </if>
      <if test="from != null">AND u.created_at &gt;= #{from}</if>
      <if test="to != null">AND u.created_at &lt;= #{to}</if>
      AND u.is_deleted = 0
    </where>
  </select>

  <!-- 상세 조회 -->
  <resultMap id="UserDetailMap" type="com.aloha.zootopia.domain.AdminUserDetail">
    <id property="userId" column="user_id"/>
    <result property="email" column="email"/>
    <result property="nickname" column="nickname"/>
    <result property="status" column="status"/>
    <result property="memo" column="memo"/>
    <result property="createdAt" column="created_at"/>
    <result property="updatedAt" column="updated_at"/>
    <result property="postCount" column="post_count"/>
    <result property="commentCount" column="comment_count"/>
  </resultMap>

  <select id="findUserById" resultMap="UserDetailMap">
    SELECT u.user_id,
           u.email,
           u.nickname,
           u.status,
           u.memo,
           u.created_at,
           u.updated_at,
           (SELECT COUNT(1)
              FROM posts p
             WHERE p.user_id = u.user_id) AS post_count,
           (SELECT COUNT(1)
              FROM post_comments c
             WHERE c.user_id = u.user_id
               AND c.is_deleted = 0) AS comment_count
      FROM users u
     WHERE u.user_id = #{userId}
       AND u.is_deleted = 0
  </select>

  <!-- ======================= -->
  <!--        Roles (email)    -->
  <!-- ======================= -->

  <!-- ✅ userId로 받은 뒤 내부에서 email join -->
  <select id="findRolesByUserId" parameterType="int" resultType="string">
    SELECT ua.auth
      FROM user_auth ua
      JOIN users u ON u.email = ua.email
     WHERE u.user_id = #{userId}
  </select>

  <!-- ✅ 삭제도 email 기준으로 -->
  <delete id="deleteRoles" parameterType="int">
    DELETE FROM user_auth
     WHERE email = (SELECT email FROM users WHERE user_id = #{userId})
  </delete>

  <!-- ✅ 단건 추가 (userId -> email 서브쿼리) -->
  <insert id="insertRole">
    INSERT INTO user_auth (email, auth)
    VALUES ((SELECT email FROM users WHERE user_id = #{userId}), #{role})
  </insert>

  <!-- ✅ 배치 추가 (userId -> email 서브쿼리) -->
  <insert id="insertRolesBatch">
    INSERT INTO user_auth (email, auth)
    VALUES
    <foreach collection="roles" item="r" separator=",">
      ((SELECT email FROM users WHERE user_id = #{userId}), #{r})
    </foreach>
  </insert>

  <!-- 사용자 필드 업데이트 -->
  <update id="updateUserFields">
    UPDATE users
       <set>
         <if test="fields.nickname != null"> nickname = #{fields.nickname}, </if>
         <if test="fields.status   != null"> status   = #{fields.status},   </if>
         <if test="fields.memo     != null"> memo     = #{fields.memo},     </if>
         updated_at = NOW()
       </set>
     WHERE user_id = #{userId}
  </update>

</mapper>
