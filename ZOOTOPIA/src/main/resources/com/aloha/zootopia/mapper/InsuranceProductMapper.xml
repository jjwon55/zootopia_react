<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.aloha.zootopia.mapper.InsuranceProductMapper">

  <resultMap id="InsuranceProductMap" type="com.aloha.zootopia.domain.InsuranceProduct">
    <id     property="productId"        column="product_id"/>
    <result property="name"             column="name"/>
    <result property="company"          column="company"/>        <!-- ✅ 회사 컬럼 매핑(추가했다면) -->
    <result property="slogan"           column="slogan"/>
    <result property="coveragePercent"  column="coverage_percent"/>
    <result property="monthlyFeeRange"  column="monthly_fee_range"/>
    <result property="maxCoverage"      column="max_coverage"/>
    <result property="species"          column="species"/>
    <result property="joinCondition"    column="join_condition"/>
    <result property="coverageItems"    column="coverage_items"/>
    <result property="precautions"      column="precautions"/>
    <result property="createdAt"        column="created_at"/>
    <result property="imagePath"        column="image_path"/>

    <!-- ✅ [추가] 외부 이동 관련 필드 매핑 -->
    <result property="sponsored" column="is_sponsored"/>
    <result property="homepageUrl"      column="homepage_url"/>
    <result property="applyUrl"         column="apply_url"/>
    <result property="partnerCode"      column="partner_code"/>
    <result property="utmSource"        column="utm_source"/>
    <result property="utmMedium"        column="utm_medium"/>
    <result property="utmCampaign"      column="utm_campaign"/>
    <!-- 도메인 필드가 boolean isSponsored 라면, property="sponsored" 로 매핑(세터 setSponsored로 동작) -->
    <result property="sponsored"        column="is_sponsored"/>
    <result property="disclaimer"       column="disclaimer"/>
  </resultMap>

  <!-- insert/update에 company 컬럼을 쓰고 있다면 여기도 포함 -->
  <insert id="insertProduct" parameterType="com.aloha.zootopia.domain.InsuranceProduct"
          useGeneratedKeys="true" keyProperty="productId">
    INSERT INTO insurance_product
    (name, company, slogan, coverage_percent, monthly_fee_range, max_coverage, species,
    join_condition, coverage_items, precautions, image_path, created_at,
    homepage_url, apply_url, partner_code, utm_source, utm_medium, utm_campaign, is_sponsored, disclaimer)
    VALUES
    (#{name}, #{company}, #{slogan}, #{coveragePercent}, #{monthlyFeeRange}, #{maxCoverage}, #{species},
    #{joinCondition}, #{coverageItems}, #{precautions}, #{imagePath}, NOW(),
    #{homepageUrl}, #{applyUrl}, #{partnerCode}, #{utmSource}, #{utmMedium}, #{utmCampaign}, #{sponsored}, #{disclaimer})
  </insert>

  <select id="selectProductById" resultMap="InsuranceProductMap">
    SELECT * FROM insurance_product WHERE product_id = #{productId}
  </select>

  <update id="updateProduct" parameterType="com.aloha.zootopia.domain.InsuranceProduct">
    UPDATE insurance_product
    SET name = #{name},
        company = #{company},
        slogan = #{slogan},
        coverage_percent = #{coveragePercent},
        monthly_fee_range = #{monthlyFeeRange},
        max_coverage = #{maxCoverage},
        species = #{species},
        join_condition = #{joinCondition},
        coverage_items = #{coverageItems},
        precautions = #{precautions},
        image_path = #{imagePath},
        homepage_url = #{homepageUrl},
        apply_url = #{applyUrl},
        partner_code = #{partnerCode},
        utm_source = #{utmSource},
        utm_medium = #{utmMedium},
        utm_campaign = #{utmCampaign},
        is_sponsored = #{sponsored},
        disclaimer = #{disclaimer}
    WHERE product_id = #{productId}
  </update>

  <delete id="deleteProduct">
    DELETE FROM insurance_product WHERE product_id = #{productId}
  </delete>

  <!-- ✅ 기존 페이징 쿼리도 size -> limit 로 통일 -->
  <select id="selectProductsPaged" resultMap="InsuranceProductMap">
    SELECT * FROM insurance_product
    ORDER BY product_id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countAllProducts" resultType="int">
    SELECT COUNT(*) FROM insurance_product
  </select>

  <!-- productFilterWhere -->
  <sql id="productFilterWhere">
    <where>
      <if test="species != null and species != '' and species != 'all'">
        AND (species = #{species} OR species = 'all')
      </if>

      <if test="company != null and company != ''">
        AND company = #{company}
      </if>

      <!-- 👇 추가: 스폰서 필터 (0/1), 파라미터 있으면 적용 -->
      <if test="sponsored != null">
        AND is_sponsored = #{sponsored}
      </if>
    </where>
  </sql>

  <select id="selectFilteredProducts" resultMap="InsuranceProductMap">
    SELECT * FROM insurance_product
    <include refid="productFilterWhere"/>
    ORDER BY product_id DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countFilteredProducts" resultType="int">
    SELECT COUNT(*)
    FROM insurance_product
    <include refid="productFilterWhere"/>
  </select>

</mapper>