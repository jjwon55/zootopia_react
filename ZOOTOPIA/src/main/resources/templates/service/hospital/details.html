<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³‘ì› ìƒì„¸</title>
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" th:href="@{/assets/dist/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/hospital_style.css}">
</head>
<body>
    <th:block th:replace="~{/fragments/header :: header}"></th:block>
    <div class="hospital-main-container">
        <!-- ìƒë‹¨ ë¡œê³  -->
        <div class="logo-container">
            <div class="logo">
                <img th:src="@{/img/hosp_logo.png}" alt="ë³‘ì› ì•„ì´ì½˜" class="logo-icon">
            </div>
        </div>

        <!-- ë™ë¬¼ ë°°ë„ˆ -->
        <div class="animal-banner">
            <div class="animal-icons">
                <span class="animal-icon">ğŸ±</span>
                <span class="animal-icon">ğŸ¶</span>
                <span class="animal-icon">ğŸ¸</span>
                <span class="text">ë³‘ì› ì†Œê°œ</span>
                <span class="animal-icon">ğŸ¦œ</span>
                <span class="animal-icon">ğŸ¹</span>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="main-content">
            <div class="detail-container">
                <div class="hospital-image-section">
                    <img th:with="imageUrl=${(hospital.thumbnailImageUrl != null and hospital.thumbnailImageUrl != '') ? hospital.thumbnailImageUrl : '/img/default-hospital.png'}"
                         th:src="@{${imageUrl}}" alt="ë³‘ì› ì´ë¯¸ì§€" class="hospital-image">
                    <!-- <img src="hospital-building.jpg" alt="ë³‘ì› ê±´ë¬¼" class="hospital-image"> -->
                </div>

                <div class="hospital-info-section">
                    <table class="info-table">
                        <tr>
                            <td class="info-label">ë³‘ì› ì´ë¦„</td>
                            <td class="info-value" th:text="${hospital.name}">ì•„í¬ë¦¬ìŠ¤ íŠ¹ìˆ˜ë™ë¬¼ ë³‘ì›</td>
                        </tr>
                        <tr>
                            <td class="info-label">ì§„ë£Œ ê³¼ëª©</td>
                            <td class="info-value">
                                <span th:each="spec : ${hospital.specialties}" th:text="${spec.category} + ' '">ì¹˜ê³¼, ì™¸ê³¼, ë‚´ê³¼, ê±´ê°•ê²€ì§„</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="info-label">ì§„ë£Œ ê°€ëŠ¥ ë™ë¬¼</td>
                            <td class="info-value">
                                <span th:each="animal : ${hospital.animals}" th:text="${animal.species} + ' '">í¬ìœ ë¥˜, íŒŒì¶©ë¥˜, ì¡°ë¥˜, ì„¤ì¹˜ë¥˜</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="info-label">ë³‘ì› ì£¼ì†Œ</td>
                            <td class="info-value" th:text="${hospital.address}">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì˜ì€ì‚¬ë¡œ 104ê¸¸ 10 ë™í™”ë¹Œë”© 3ì¸µ</td>
                        </tr>
                        <tr>
                            <td class="info-label">í™ˆí˜ì´ì§€</td>
                            <td class="info-value">
                                <a th:href="${hospital.homepage}" th:text="${hospital.homepage}">https://acrisamc.co.kr/</a>
                            </td>
                        </tr>
                        <tr>
                            <td class="info-label">ëŒ€í‘œë²ˆí˜¸</td>
                            <td class="info-value" th:text="${hospital.phone}">02-583-7582</td>
                        </tr>
                        <tr>
                            <td class="info-label">ì´ë©”ì¼</td>
                            <td class="info-value" th:text="${hospital.email}">X</td>
                        </tr>
                        <tr>
                            <td class="info-label">ë³‘ì› ì†Œê°œ</td>
                            <td class="info-value" th:text="${hospital.hospIntroduce}">X</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- ê´€ë¦¬ììš© ë²„íŠ¼ -->
            <div class="mb-3" style="text-align: right; margin-top: 20px;" sec:authorize="hasAuthority('ROLE_ADMIN')">
                <a th:href="@{/service/hospitals/edit/{id}(id=${hospital.hospitalId})}" class="hosp btn btn-primary">ìˆ˜ì •í•˜ê¸°</a>
            </div>

            <!-- ë³‘ì› ë¦¬ë·° ì„¹ì…˜ -->
            <div class="review-section">
                <div class="review-header">
                    <h3>ì´ ë³‘ì› ì–´ë•Œìš”?</h3>
                    <span id="review-count" style="margin-left: 10px; font-size: 0.9em; color: gray;"></span>
                </div>

                <!-- ë¦¬ë·° ëª©ë¡ -->
                <div id="review-list" class="review-list">
                    <!-- ë¦¬ë·°ê°€ ë™ì ìœ¼ë¡œ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤. -->
                </div>

                <!-- ë¦¬ë·° ì‘ì„± í¼ (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì—ê²Œë§Œ í‘œì‹œ) -->
                <div id="review-form-container" sec:authorize="isAuthenticated()">
                    <h4>ë¦¬ë·° ì‘ì„±</h4>
                    <form id="review-form" class="review-form">
                        <input type="hidden" id="reviewId" name="reviewId">
                        <div class="rating">
                            <span class="star" data-value="1">â˜…</span>
                            <span class="star" data-value="2">â˜…</span>
                            <span class="star" data-value="3">â˜…</span>
                            <span class="star" data-value="4">â˜…</span>
                            <span class="star" data-value="5">â˜…</span>
                        </div>
                        <input type="hidden" id="rating" name="rating" value="0">
                        <div class="review-input-container">
                            <textarea id="content" name="content" class="review-input" placeholder="ë¦¬ë·°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”." required></textarea>
                            <button type="submit" class="review-submit-btn">ë“±ë¡</button>
                        </div>
                    </form>
                </div>
            </div>

    </div>
</div>
    <th:block th:replace="~{/fragments/footer :: footer}"></th:block>

    <script th:inline="javascript">
        const hospitalId = /*[[${hospital.hospitalId}]]*/ 0;
        const currentUserId = /*[[${#authentication.principal != 'anonymousUser' and #authentication.principal.user != null ? #authentication.principal.user.userId : null}]]*/ null;

        document.addEventListener('DOMContentLoaded', () => {
            loadReviews();

            // ë¡œê·¸ì¸í•œ ê²½ìš°ì—ë§Œ ë³„ì  ë° í¼ ì œì¶œ ì´ë²¤íŠ¸ ì„¤ì •
            if (document.getElementById('review-form-container')) {
                setupStarRating();
                handleFormSubmit();
            }
        });

        // ë¦¬ë·° ëª©ë¡ ë¡œë“œ
        async function loadReviews() {
            try {
                const response = await fetch(`/service/hospitals/${hospitalId}/reviews`);
                if (!response.ok) throw new Error('ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

                const reviews = await response.json();
                const reviewList = document.getElementById('review-list');
                reviewList.innerHTML = '';

                // ë¦¬ë·° ê°œìˆ˜ ì—…ë°ì´íŠ¸
                const reviewCountSpan = document.getElementById('review-count');
                if (reviewCountSpan) {
                    reviewCountSpan.textContent = `ë“±ë¡ëœ ë¦¬ë·° : (${reviews.length}ê°œ)`;
                }

                reviews.forEach(review => {
                    const reviewElement = document.createElement('div');
                    reviewElement.classList.add('review-item');
                    reviewElement.dataset.reviewId = review.reviewId;

                    const editDeleteButtons = currentUserId === review.userId
                        ? `<div class="review-update-container">
                               <button onclick="editReview(${review.reviewId}, ${review.rating}, '${review.content}')">ìˆ˜ì •</button>
                               <button onclick="deleteReview(${review.reviewId})">ì‚­ì œ</button>
                           </div>`
                        : '';

                    reviewElement.innerHTML = `
                        <div class="review-rating">
                            <div class="author-rating">
                                <strong class="review-author">${review.userNickname}</strong>
                                <div class="star-rating"></div>
                            </div>
                            ${editDeleteButtons}
                        </div>
                        <div class="review-date-container">
                            <span class="review-date">${new Date(review.createdAt).toLocaleString('ko-KR', {
                                                                                                            year: '2-digit',
                                                                                                            month: '2-digit',
                                                                                                            day: '2-digit',
                                                                                                            hour: '2-digit',
                                                                                                            minute: '2-digit',
                                                                                                            second: '2-digit'
                                                                                                        })}</span>
                        </div>
                        <hr class="border border-1 opacity-50">
                        <p class="review-content">${review.content}</p>
                    `;

                    // ë³„ì  í‘œì‹œ
                    const starRating = reviewElement.querySelector('.star-rating');
                    for (let i = 1; i <= 5; i++) {
                        starRating.innerHTML += i <= review.rating ? 'â˜…' : 'â˜†';
                    }

                    reviewList.appendChild(reviewElement);
                });
            } catch (error) {
                console.error('Error loading reviews:', error);
                const reviewList = document.getElementById('review-list');
                reviewList.innerHTML = '<p>ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ë³„ì  ì²˜ë¦¬ ì„¤ì •
        function setupStarRating() {
            const stars = document.querySelectorAll('#review-form .rating .star');
            const ratingInput = document.getElementById('rating');

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = star.getAttribute('data-value');
                    ratingInput.value = value;
                    stars.forEach(s => {
                        s.classList.toggle('selected', s.getAttribute('data-value') <= value);
                    });
                });
            });
        }

        // ë¦¬ë·° í¼ ì œì¶œ ì²˜ë¦¬
        function handleFormSubmit() {
            const form = document.getElementById('review-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const rating = document.getElementById('rating').value;
                const content = document.getElementById('content').value.trim();
                const reviewId = document.getElementById('reviewId').value;

                if (rating === '0' || content === '') {
                    alert('ë³„ì ê³¼ ë¦¬ë·° ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const url = reviewId
                    ? `/service/hospitals/${hospitalId}/reviews/${reviewId}`
                    : `/service/hospitals/${hospitalId}/reviews`;
                const method = reviewId ? 'PUT' : 'POST';

                // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken // CSRF í† í° ì¶”ê°€
                        },
                        body: JSON.stringify({ hospitalId: hospitalId, rating: parseInt(rating), content: content }),
                    });

                    if (response.ok) {
                        loadReviews();
                        form.reset();
                        document.getElementById('reviewId').value = '';
                        document.querySelectorAll('#review-form .rating .star').forEach(s => s.classList.remove('selected'));
                        document.querySelector('#review-form button[type="submit"]').textContent = 'ë“±ë¡';
                    } else {
                        const errorText = await response.text();
                        alert(`ë¦¬ë·° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Error submitting review:', error);
                    alert('ë¦¬ë·° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        // ë¦¬ë·° ìˆ˜ì • í¼ ì±„ìš°ê¸°
        function editReview(id, rating, content) {
            document.getElementById('reviewId').value = id;
            document.getElementById('rating').value = rating;
            document.getElementById('content').value = content;

            // ë³„ì  ì‹œê°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            const stars = document.querySelectorAll('#review-form .rating .star');
            stars.forEach(s => {
                s.classList.toggle('selected', s.getAttribute('data-value') <= rating);
            });

            document.querySelector('#review-form button[type="submit"]').textContent = 'ìˆ˜ì •';
            document.getElementById('review-form-container').scrollIntoView({ behavior: 'smooth' });
        }

        // ë¦¬ë·° ì‚­ì œ
        async function deleteReview(id) {
            if (!confirm('ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            try {
                const response = await fetch(`/service/hospitals/${hospitalId}/reviews/${id}`, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken // CSRF í† í° ì¶”ê°€
                    }
                });

                if (response.ok) {
                    loadReviews();
                } else {
                    const errorText = await response.text();
                    alert(`ë¦¬ë·° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorText}`);
                }
            } catch (error) {
                console.error('Error deleting review:', error);
                alert('ë¦¬ë·° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
    <script th:src="@{/assets/dist/js/header.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>