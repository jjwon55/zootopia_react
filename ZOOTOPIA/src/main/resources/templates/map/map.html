<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <title>ë‚´ ì£¼ë³€ ê²€ìƒ‰</title>
  <script type="text/javascript"
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=042e9d921821591dcceda5a68e03040f&libraries=services"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" th:href="@{/assets/dist/css/header.css}" />
  <link rel="stylesheet" th:href="@{/css/map.css}" />
</head>

<body>
  <div th:replace="fragments/header :: header"></div>

  <div class="map_container">
    <div class="map-layout d-flex">
      <!-- ğŸ“ ì™¼ìª½: ê²€ìƒ‰ ì˜ì—­ -->
      <div class="left-panel d-flex flex-column gap-2">
        <div class="custom-search-bar">
          <input type="text" id="keyword" class="custom-search-input" placeholder="ì¥ì†Œ, ê²€ìƒ‰" />
          <button class="custom-search-button" onclick="search()">
            <i class="bi bi-search"></i>
          </button>
        </div>
        <div id="placesList" class="list-panel"></div>
      </div>

      <!-- ğŸ—ºï¸ ì˜¤ë¥¸ìª½: ì§€ë„ ì˜ì—­ -->
      <div id="map" class="map-panel"></div>
    </div>
  </div>

  <div id="popup" class="custom-popup" style="display:none"></div>
  <div th:replace="fragments/footer :: footer"></div>

  <script th:src="@{/assets/dist/js/header.js}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    var map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(37.5665, 126.9780), // ê¸°ë³¸ê°’: ì„œìš¸ ì‹œì²­
      level: 4
    });

    var ps = new kakao.maps.services.Places();
    var markers = [];

    // ë°˜ê²½ ê³„ì‚°
    function getRadiusByLevel(level) {
      if (level <= 3) return 1000;
      if (level === 4) return 2000;
      if (level === 5) return 3000;
      if (level === 6) return 5000;
      if (level === 7) return 8000;
      if (level === 8) return 10000;
      if (level === 9) return 15000;
      return 20000;
    }

    // ì¥ì†Œ ê²€ìƒ‰
    function search(centerLatLng) {
      const keyword = document.getElementById('keyword').value.trim();
      if (!keyword) {
        alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      const loc = centerLatLng || map.getCenter(); // ì§€ë„ ì¤‘ì‹¬ ë˜ëŠ” ì œê³µëœ ì¢Œí‘œ
      const radius = getRadiusByLevel(map.getLevel());

      map.setCenter(loc);
      clearMarkers();

      ps.keywordSearch(keyword, function (data, status) {
        const listEl = document.getElementById('placesList');
        listEl.innerHTML = '';

        if (status === kakao.maps.services.Status.OK) {
          data.forEach(place => {
            const coords = new kakao.maps.LatLng(place.y, place.x);
            const marker = new kakao.maps.Marker({ map: map, position: coords });
            markers.push(marker);

            kakao.maps.event.addListener(marker, 'click', function () {
              showPopup(place);
            });

            const item = document.createElement('div');
            item.className = 'place-item';
            item.innerHTML = `
            <strong>${place.place_name}</strong><br>
            ${place.road_address_name || place.address_name}
          `;
            item.onclick = () => {
              map.setCenter(coords);
              showPopup(place);
            };
            listEl.appendChild(item);
          });
        }
        // else {
        //   alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        // }
      }, {
        location: loc,
        radius: radius
      });
    }

    // ë§ˆì»¤ ì´ˆê¸°í™”
    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }

    // íŒì—… í‘œì‹œ
    let customOverlay; // ì „ì—­ ì„ ì–¸

    function showPopup(place) {
      // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
      if (customOverlay) customOverlay.setMap(null);

      const content = `
    <div class="overlay-wrapper">
      <div class="overlay-content">
        <div class="title">
          <strong>${place.place_name}</strong>
          <button class="close-btn" onclick="closeOverlay()">X</button>
        </div>
        <div class="body">
          <div class="address">${place.road_address_name || place.address_name}</div>
          ${place.phone ? `<div class="phone">${place.phone}</div>` : ""}
          <div class="link">
            <a href="${place.place_url}" target="_blank">ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a>
          </div>
        </div>
      </div>
      <div class="overlay-arrow"></div>
    </div>
  `;

      customOverlay = new kakao.maps.CustomOverlay({

        content: content,
        position: new kakao.maps.LatLng(place.y, place.x),
        xAnchor: 0.5,
        yAnchor: 1.1
      });

      customOverlay.setMap(map);
    }

    function closeOverlay() {
      if (customOverlay) {
        customOverlay.setMap(null); // ì§€ë„ì—ì„œ ì œê±°
      }
    }
    // ì§€ë„ ì´ë™ í›„ ìë™ ê²€ìƒ‰
    kakao.maps.event.addListener(map, 'idle', function () {
      const keyword = document.getElementById('keyword').value.trim();
      if (keyword) {
        search(); // ì§€ë„ ì¤‘ì‹¬ ê¸°ì¤€ ìë™ ì¬ê²€ìƒ‰
      }
    });

    // ìµœì´ˆ ë¡œë”© ì‹œ ë‚´ ìœ„ì¹˜ ê¸°ë°˜ ì²« ê²€ìƒ‰
    window.onload = () => {
      document.getElementById('keyword').value = 'ë™ë¬¼ë³‘ì›';

      // ğŸ” ì—”í„° í‚¤ ì…ë ¥ ì‹œ ê²€ìƒ‰
      document.getElementById('keyword').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          search();
        }
      });

      navigator.geolocation.getCurrentPosition(function (position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const myLoc = new kakao.maps.LatLng(lat, lng);
        search(myLoc); // ë‚´ ìœ„ì¹˜ ê¸°ë°˜ ì²« ê²€ìƒ‰
      }, function (error) {
        alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.");
        search(); // fallback: ì„œìš¸ ì‹œì²­
      });
    };
  </script>

</body>

</html>